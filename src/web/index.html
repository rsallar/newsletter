<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <!-- Aquí incluimos el contenido del fichero CSS -->
    <?!= include('src/web/stylesheet.html'); ?>
  </head>
  <body>
    <div class="container">
      <h1>Configuración de la Newsletter</h1>
      
      <!-- Contenedor para el enlace a la hoja de cálculo -->
      <div id="spreadsheetLinkContainer" class="spreadsheet-link">
        <a href="#" target="_blank" rel="noopener noreferrer" style="display:none;">Abrir Hoja de Cálculo de Datos</a>
        <p>Cargando enlace a la hoja de cálculo...</p>
      </div>
      
      <h2>Configurar Palabras Clave y Automatización</h2>

      <h3>Palabras Clave Actuales</h3>
      <div id="keywordList"><p class="list-item-empty">Cargando palabras clave...</p></div>
      <div id="statusKeywords" class="status-message"></div>
      
      <form id="configForm">
        <label for="keywords">Editar lista de Palabras Clave (separadas por comas):</label>
        <input type="text" id="keywords" name="keywords" placeholder="Ej: inteligencia artificial, apps script, computación cuántica">
        <br><br>
        <input type="submit" value="Guardar Configuración y Activar Proceso Semanal">
      </form>
      <div id="statusFase1" class="status-message"></div>
      <div id="instructionsFase1" class="status-message"></div>

      <h3>Activador Semanal Configurado</h3>
      <div id="triggerList"><p class="list-item-empty">Cargando activador...</p></div>

      <hr>

      <h2>Acción Manual</h2>
      <p>Si no quieres esperar al activador semanal, puedes ejecutar todo el proceso ahora mismo. Si encuentras errores relacionados con el "modelo" de IA, usa el botón 'Listar Modelos' para ver los que están disponibles para tu API Key.</p>
      <div class="manual-actions-container">
        <button id="manualProcesoBtn" class="btn btn-success" style="flex-grow: 1;">Buscar Noticias y Enviar Newsletter</button>
        <button id="listModelsBtn" class="btn btn-info">Listar Modelos de IA</button>
      </div>
      <!-- Este contenedor mostrará los logs del proceso manual -->
      <div id="statusManual" class="log-container"></div>

      <hr>
      
      <h2>Gestión de Correos Electrónicos</h2>
      <form id="emailForm">
        <label for="email">Correo Electrónico:</label>
        <input type="email" id="email" name="email" placeholder="nombre@ejemplo.com" required>
        <br><br>
        <input type="submit" value="Agregar Correo">
      </form>
      <div id="statusEmail" class="status-message"></div>
      <h3>Lista de Correos</h3>
      <div id="emailList"><p class="list-item-empty">Cargando lista de correos...</p></div>
    </div>

    <script>
      /**
       * Muestra un mensaje de estado con un botón de cierre manual.
       */
      function showStatus(elementId, message, isError = false) {
        const statusDiv = document.getElementById(elementId);
        // El mensaje se envuelve en un span para que el flexbox funcione correctamente
        statusDiv.innerHTML = `<span>${message}</span><button class="close-btn" aria-label="Cerrar">&times;</button>`;
        statusDiv.style.color = isError ? 'var(--danger-color)' : 'var(--success-color)';
        statusDiv.style.backgroundColor = isError ? '#f8d7da' : '#d4edda';
        statusDiv.style.borderColor = isError ? '#f5c6cb' : '#c3e6cb';
        statusDiv.style.border = '1px solid';
        statusDiv.style.display = 'flex'; // Hacer visible el contenedor

        if(message.includes("ACCIÓN MANUAL REQUERIDA")){
            statusDiv.classList.add("permanent-instructions");
        } else {
            statusDiv.classList.remove("permanent-instructions");
        }
      }
      
      /**
       * Carga las keywords actuales y las muestra en la lista y en el campo de texto.
       */
      function cargarKeywordsActuales() {
        google.script.run
          .withSuccessHandler(function(keywords) {
            document.getElementById('keywords').value = keywords;
            const listDiv = document.getElementById('keywordList');
            const keywordsArray = keywords.split(',').map(k => k.trim()).filter(Boolean);

            if (keywordsArray.length === 0) {
              listDiv.innerHTML = '<p class="list-item-empty">No hay palabras clave configuradas.</p>';
              return;
            }

            let html = '<ul class="list">';
            keywordsArray.forEach(function(kw) {
              html += `<li class="list-item"><span>${kw}</span> <button class="btn delete-btn" data-keyword="${kw}">Eliminar</button></li>`;
            });
            html += '</ul>';
            listDiv.innerHTML = html;
          })
          .withFailureHandler(function(error) {
            showStatus('statusKeywords', 'Error al cargar las keywords: ' + error.message, true);
          })
          .obtenerKeywordsActuales();
      }

      /**
       * Carga y muestra la lista de activadores del proyecto.
       */
      function cargarTriggers() {
        google.script.run
          .withSuccessHandler(function(triggers) {
            const listDiv = document.getElementById('triggerList');
            if (triggers.length === 0) {
              listDiv.innerHTML = '<p class="list-item-empty">No hay activadores configurados. Guarda tus palabras clave para crear uno.</p>';
              return;
            }
            let html = '<ul class="list">';
            triggers.forEach(function(trigger) {
              html += `<li class="list-item"><span><strong>Función:</strong> ${trigger.handlerFunction}, <strong>Tipo:</strong> ${trigger.eventType} (semanal)</span></li>`;
            });
            html += '</ul>';
            listDiv.innerHTML = html;
          })
          .withFailureHandler(function(error) {
            document.getElementById('triggerList').innerHTML = `<p class="list-item-empty" style="color:var(--danger-color);">Error al cargar los activadores: ${error.message}</p>`;
          })
          .obtenerTriggers();
      }
      
      /**
       * Carga y muestra la lista de correos electrónicos.
       */
      function cargarCorreos() {
        google.script.run
          .withSuccessHandler(function(correos) {
            const listDiv = document.getElementById('emailList');
            if (correos.length === 0) {
              listDiv.innerHTML = '<p class="list-item-empty">No hay correos en la lista.</p>';
              return;
            }
            let html = '<ul class="list">';
            correos.forEach(function(correo) {
              html += `<li class="list-item"><span>${correo}</span> <button class="btn delete-btn" data-email="${correo}">Eliminar</button></li>`;
            });
            html += '</ul>';
            listDiv.innerHTML = html;
          })
          .withFailureHandler(function(error) {
             showStatus('statusEmail', 'Error al cargar los correos: ' + error.message, true);
          })
          .obtenerCorreos();
      }

      /**
       * Carga y muestra el enlace a la hoja de cálculo de datos del proyecto.
       */
      function cargarSpreadsheetUrl() {
        google.script.run
          .withSuccessHandler(function(url) {
            const container = document.getElementById('spreadsheetLinkContainer');
            const link = container.querySelector('a');
            const loadingText = container.querySelector('p');
            
            if (link && url) {
              link.href = url;
              link.style.display = 'inline-block';
            }
            if (loadingText) {
              loadingText.style.display = 'none';
            }
          })
          .withFailureHandler(function(error) {
            const container = document.getElementById('spreadsheetLinkContainer');
            container.innerHTML = `<p style="color:var(--danger-color); font-style:italic;">No se pudo cargar el enlace a la hoja de cálculo: ${error.message}</p>`;
          })
          .getSpreadsheetUrl(); // Llamada a la nueva función del backend
      }


      // Cargar los datos iniciales cuando la página se carga
      document.addEventListener('DOMContentLoaded', function() {
        cargarSpreadsheetUrl();
        cargarKeywordsActuales();
        cargarTriggers();
        cargarCorreos();

        // Event listener para los botones de cierre en las alertas
        document.addEventListener('click', function(e) {
          if (e.target && e.target.classList.contains('close-btn')) {
            const statusDiv = e.target.parentElement;
            statusDiv.innerHTML = '';
            statusDiv.style.display = 'none'; // Ocultar el div
          }
        });
      });

      // --- MANEJADORES DE EVENTOS ---

      // Formulario de configuración
      document.getElementById('configForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const submitBtn = this.querySelector('input[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.value = "Guardando...";
        const keywords = document.getElementById('keywords').value;
        
        google.script.run
          .withSuccessHandler(function(response) {
            showStatus('statusFase1', response.successMessage, false);
            showStatus('instructionsFase1', response.instructions, false); 
            cargarTriggers();
            cargarKeywordsActuales(); 
            submitBtn.disabled = false;
            submitBtn.value = "Guardar Configuración y Activar Proceso Semanal";
          })
          .withFailureHandler(function(error) {
            showStatus('statusFase1', 'Error: ' + error.message, true);
            submitBtn.disabled = false;
            submitBtn.value = "Guardar Configuración y Activar Proceso Semanal";
          })
          .guardarConfiguracion(keywords);
      });
      
      // Eliminar keywords
      document.getElementById('keywordList').addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('delete-btn')) {
            const keyword = e.target.dataset.keyword;
            if (confirm(`¿Estás seguro de que quieres eliminar la palabra clave "${keyword}"?`)) {
                e.target.disabled = true;
                e.target.innerText = 'Eliminando...';
                google.script.run
                    .withSuccessHandler(function(response) {
                        showStatus('statusKeywords', response, false);
                        cargarKeywordsActuales();
                        cargarTriggers(); // Recargamos triggers por si se eliminó el último
                    })
                    .withFailureHandler(function(error) {
                        showStatus('statusKeywords', 'Error: ' + error.message, true);
                        e.target.disabled = false;
                        e.target.innerText = 'Eliminar';
                    })
                    .eliminarKeyword(keyword);
            }
        }
      });

      // --- NUEVA LÓGICA PARA EL PROCESO MANUAL ---

      /**
       * Añade una línea al contenedor de logs en la interfaz.
       * @param {string} message - El mensaje a mostrar.
       * @param {boolean} isError - Si es un mensaje de error.
       * @param {boolean} isSuccess - Si es un mensaje de éxito final.
       */
      function addLog(message, isError = false, isSuccess = false) {
        const logContainer = document.getElementById('statusManual');
        logContainer.style.display = 'block'; // Asegurarse de que el contenedor es visible

        const logEntry = document.createElement('p');
        logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;

        if (isError) logEntry.className = 'log-error';
        if (isSuccess) logEntry.className = 'log-success';

        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight; // Auto-scroll al final
      }

      // Botón del Proceso Manual Completo
      document.getElementById('manualProcesoBtn').addEventListener('click', function() {
        const btn = this;
        btn.disabled = true;
        btn.innerText = 'Ejecutando...';

        const logContainer = document.getElementById('statusManual');
        logContainer.innerHTML = ''; // Limpiar logs anteriores
        
        addLog('Iniciando proceso manual...');

        // Encadenamos las llamadas a las nuevas funciones del backend usando promesas
        new Promise((resolve, reject) => {
          addLog('Paso 1/4: Obteniendo palabras clave...');
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .iniciarProcesoManual_Paso1_GetKeywords();
        })
        .then(keywordsArray => {
          addLog(`  > Éxito. Keywords: ${keywordsArray.join(', ')}`);
          addLog('Paso 2/4: Buscando noticias recientes...');
          return new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .iniciarProcesoManual_Paso2_SearchNews(keywordsArray);
          });
        })
        .then(noticias => {
          addLog(`  > Éxito. Se encontraron ${noticias.length} noticias.`);
          addLog('Paso 3/4: Generando contenido con IA...');
          return new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .iniciarProcesoManual_Paso3_GenerateContent(noticias);
          });
        })
        .then(data => {
          addLog('  > Éxito. Contenido de la newsletter generado.');
          addLog('Paso 4/4: Enviando newsletter por correo...');
          return new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .iniciarProcesoManual_Paso4_SendEmails(data);
          });
        })
        .then(finalMessage => {
          addLog(finalMessage, false, true); // Mensaje final de éxito
        })
        .catch(error => {
          addLog(`ERROR: ${error.message}`, true); // Captura cualquier error en la cadena
        })
        .finally(() => {
          // Esto se ejecuta siempre, tanto si hay éxito como si hay error
          btn.disabled = false;
          btn.innerText = 'Buscar Noticias y Enviar Newsletter';
        });
      });

      // --- NUEVO MANEJADOR DE EVENTO PARA LISTAR MODELOS ---
      document.getElementById('listModelsBtn').addEventListener('click', function() {
        const btn = this;
        btn.disabled = true;
        btn.innerText = 'Listando...';
        
        const logContainer = document.getElementById('statusManual');
        logContainer.innerHTML = ''; // Limpiar logs anteriores
        addLog('Solicitando lista de modelos a la API de Gemini...');

        const reEnableButton = () => {
            btn.disabled = false;
            btn.innerText = 'Listar Modelos de IA';
        };

        google.script.run
            .withSuccessHandler(function(models) {
                if (models && models.length > 0) {
                    addLog('Modelos disponibles encontrados:', false, true);
                    let modelsText = models.map(model => {
                        return `\n- Nombre: ${model.name}\n  (Display: ${model.displayName})\n  (Métodos: ${model.supportedMethods.join(', ') || 'ninguno'})`;
                    }).join('');
                    addLog('--- INICIO LISTA ---' + modelsText + '\n--- FIN LISTA ---');
                    addLog("INSTRUCCIÓN: Si el proceso automático falla por un error de 'modelo no encontrado', edita el fichero 'src/utils/gemini.gs' en tu código. Busca las dos variables 'API_URL' y reemplaza el modelo (ej: 'gemini-1.0-pro') por uno de esta lista que soporte el método 'generateContent'.", false, true);
                } else {
                    addLog('No se encontraron modelos disponibles. Verifica que tu API Key es correcta y está asociada a un proyecto con la API "Generative Language" habilitada.', true);
                }
                reEnableButton();
            })
            .withFailureHandler(function(error) {
                addLog(`ERROR al listar modelos: ${error.message}`, true);
                reEnableButton();
            })
            .listarModelosGemini();
      });

      // Formulario de correos
      document.getElementById('emailForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const emailInput = document.getElementById('email');
        const email = emailInput.value.trim();
        if (!email) return;
        
        const submitBtn = this.querySelector('input[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.value = "Agregando...";

        google.script.run
          .withSuccessHandler(function(response) {
            showStatus('statusEmail', response, false);
            emailInput.value = '';
            cargarCorreos();
            submitBtn.disabled = false;
            submitBtn.value = "Agregar Correo";
          })
          .withFailureHandler(function(error) {
            showStatus('statusEmail', 'Error: ' + error.message, true);
            submitBtn.disabled = false;
            submitBtn.value = "Agregar Correo";
          })
          .agregarCorreo(email);
      });
      
      // Eliminar correos
      document.getElementById('emailList').addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('delete-btn')) {
          e.target.disabled = true; 
          const email = e.target.dataset.email;
          if (confirm(`¿Estás seguro de que quieres eliminar el correo "${email}"?`)) {
            google.script.run
              .withSuccessHandler(function(response) {
                showStatus('statusEmail', response, false);
                cargarCorreos();
              })
              .withFailureHandler(function(error) {
                showStatus('statusEmail', 'Error: ' + error.message, true);
                e.target.disabled = false; 
              })
              .eliminarCorreo(email);
          } else {
            e.target.disabled = false;
          }
        }
      });
    </script>
  </body>
</html>
