<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <!-- Aquí incluimos el contenido del fichero CSS -->
    <?!= include('src/web/stylesheet.html'); ?>
  </head>
  <body>
    <div class="container">
      <h1>Configuración de la Newsletter</h1>
      
      <div id="spreadsheetLinkContainer" class="spreadsheet-link">
        <a href="#" target="_blank" rel="noopener noreferrer" style="display:none;">Abrir Hoja de Cálculo de Datos</a>
        <p>Cargando enlace a la hoja de cálculo...</p>
      </div>
      
      <h2>Configurar Palabras Clave y Automatización</h2>

      <h3>Palabras Clave Actuales</h3>
      <div id="keywordList"><p class="list-item-empty">Cargando palabras clave...</p></div>
      <div id="statusKeywords" class="status-message"></div>
      
      <form id="configForm">
        <label for="keywords">Editar lista de Palabras Clave (separadas por comas):</label>
        <input type="text" id="keywords" name="keywords" placeholder="Ej: inteligencia artificial, apps script, computación cuántica">
        
        <br><br>
        <label for="aiModel">Modelo de IA a Utilizar:</label>
        <select id="aiModel" name="aiModel" disabled>
          <option value="">Cargando modelos...</option>
        </select>
        
        <br><br>
        <label for="prompt">Prompt para la IA (la variable <code>{NOTICIAS_TEXTO}</code> será reemplazada):</label>
        <textarea id="prompt" name="prompt" rows="12" placeholder="Describe aquí cómo quieres que la IA genere la newsletter..."></textarea>

        <br><br>
        <input type="submit" value="Guardar Configuración y Activar Proceso Semanal">
      </form>
      <div id="statusFase1" class="status-message"></div>
      <div id="instructionsFase1" class="status-message"></div>

      <h3>Activador Semanal Configurado</h3>
      <div id="triggerList"><p class="list-item-empty">Cargando activador...</p></div>

      <hr>

      <h2>Acción Manual</h2>
      <p>Si no quieres esperar al activador semanal, puedes ejecutar todo el proceso ahora mismo.</p>
      <div class="manual-actions-container">
        <button id="manualProcesoBtn" class="btn btn-success" style="flex-grow: 1;">Buscar Noticias y Enviar Newsletter</button>
      </div>
      <div id="statusManual" class="log-container"></div>

      <hr>
      
      <h2>Gestión de Correos Electrónicos</h2>
      <form id="emailForm">
        <label for="email">Correo Electrónico:</label>
        <input type="email" id="email" name="email" placeholder="nombre@ejemplo.com" required>
        <br><br>
        <input type="submit" value="Agregar Correo">
      </form>
      <div id="statusEmail" class="status-message"></div>
      <h3>Lista de Correos</h3>
      <div id="emailList"><p class="list-item-empty">Cargando lista de correos...</p></div>
    </div>

    <script>
      function showStatus(elementId, message, isError = false) {
        const statusDiv = document.getElementById(elementId);
        statusDiv.innerHTML = `<span>${message}</span><button class="close-btn" aria-label="Cerrar">&times;</button>`;
        statusDiv.style.color = isError ? 'var(--danger-color)' : 'var(--success-color)';
        statusDiv.style.backgroundColor = isError ? '#f8d7da' : '#d4edda';
        statusDiv.style.borderColor = isError ? '#f5c6cb' : '#c3e6cb';
        statusDiv.style.border = '1px solid';
        statusDiv.style.display = 'flex';

        if(message.includes("ACCIÓN MANUAL REQUERIDA")){
            statusDiv.classList.add("permanent-instructions");
        } else {
            statusDiv.classList.remove("permanent-instructions");
        }
      }
      
      function cargarModelosDisponibles(modeloGuardado) {
          const select = document.getElementById('aiModel');
          google.script.run
              .withSuccessHandler(function(models) {
                  select.innerHTML = '';
                  if (!models || models.length === 0) {
                      select.innerHTML = '<option value="">No se encontraron modelos</option>';
                      showStatus('statusFase1', 'No se pudieron cargar los modelos de IA. Revisa tu API Key.', true);
                      return;
                  }
                  const modelosValidos = models.filter(m => m.supportedMethods.includes('generateContent'));
                  if(modelosValidos.length === 0){
                      select.innerHTML = '<option value="">No hay modelos compatibles</option>';
                      showStatus('statusFase1', 'Se encontraron modelos, pero ninguno soporta "generateContent".', true);
                      return;
                  }
                  modelosValidos.forEach(model => {
                      const option = document.createElement('option');
                      option.value = model.name;
                      option.textContent = `${model.displayName} (${model.name.split('/')[1]})`;
                      if (model.name === modeloGuardado) {
                          option.selected = true;
                      }
                      select.appendChild(option);
                  });
                  select.disabled = false;
              })
              .withFailureHandler(function(error) {
                  select.innerHTML = `<option value="">Error al cargar</option>`;
                  showStatus('statusFase1', 'Error fatal al cargar modelos de IA: ' + error.message, true);
              })
              .listarModelosGemini();
      }

      function cargarConfiguracionActual() {
          google.script.run
              .withSuccessHandler(function(config) {
                  document.getElementById('keywords').value = config.keywords;
                  document.getElementById('prompt').value = config.prompt;
                  const listDiv = document.getElementById('keywordList');
                  const keywordsArray = config.keywords.split(',').map(k => k.trim()).filter(Boolean);
                  if (keywordsArray.length === 0) {
                      listDiv.innerHTML = '<p class="list-item-empty">No hay palabras clave configuradas.</p>';
                  } else {
                      let html = '<ul class="list">';
                      keywordsArray.forEach(function(kw) {
                          html += `<li class="list-item"><span>${kw}</span> <button class="btn delete-btn" data-keyword="${kw}">Eliminar</button></li>`;
                      });
                      html += '</ul>';
                      listDiv.innerHTML = html;
                  }
                  cargarModelosDisponibles(config.model);
              })
              .withFailureHandler(function(error) {
                  showStatus('statusKeywords', 'Error al cargar la configuración: ' + error.message, true);
              })
              .obtenerConfiguracion();
      }

      function cargarTriggers() {
        google.script.run
          .withSuccessHandler(function(triggers) {
            const listDiv = document.getElementById('triggerList');
            if (triggers.length === 0) {
              listDiv.innerHTML = '<p class="list-item-empty">No hay activadores configurados. Guarda tus palabras clave para crear uno.</p>';
              return;
            }
            let html = '<ul class="list">';
            triggers.forEach(function(trigger) {
              html += `<li class="list-item"><span><strong>Función:</strong> ${trigger.handlerFunction}, <strong>Tipo:</strong> ${trigger.eventType} (semanal)</span></li>`;
            });
            html += '</ul>';
            listDiv.innerHTML = html;
          })
          .withFailureHandler(function(error) {
            document.getElementById('triggerList').innerHTML = `<p class="list-item-empty" style="color:var(--danger-color);">Error: ${error.message}</p>`;
          })
          .obtenerTriggers();
      }
      
      function cargarCorreos() {
        google.script.run
          .withSuccessHandler(function(correos) {
            const listDiv = document.getElementById('emailList');
            if (correos.length === 0) {
              listDiv.innerHTML = '<p class="list-item-empty">No hay correos en la lista.</p>';
              return;
            }
            let html = '<ul class="list">';
            correos.forEach(function(correo) {
              html += `<li class="list-item"><span>${correo}</span> <button class="btn delete-btn" data-email="${correo}">Eliminar</button></li>`;
            });
            html += '</ul>';
            listDiv.innerHTML = html;
          })
          .withFailureHandler(function(error) {
             showStatus('statusEmail', 'Error al cargar los correos: ' + error.message, true);
          })
          .obtenerCorreos();
      }

      function cargarSpreadsheetUrl() {
        google.script.run
          .withSuccessHandler(function(url) {
            const container = document.getElementById('spreadsheetLinkContainer');
            const link = container.querySelector('a');
            const loadingText = container.querySelector('p');
            if (link && url) {
              link.href = url;
              link.style.display = 'inline-block';
            }
            if (loadingText) {
              loadingText.style.display = 'none';
            }
          })
          .withFailureHandler(function(error) {
            const container = document.getElementById('spreadsheetLinkContainer');
            container.innerHTML = `<p style="color:var(--danger-color); font-style:italic;">Error: ${error.message}</p>`;
          })
          .getSpreadsheetUrl();
      }

      document.addEventListener('DOMContentLoaded', function() {
        cargarSpreadsheetUrl();
        cargarConfiguracionActual();
        cargarTriggers();
        cargarCorreos();
        document.addEventListener('click', function(e) {
          if (e.target && e.target.classList.contains('close-btn')) {
            const statusDiv = e.target.parentElement;
            statusDiv.innerHTML = '';
            statusDiv.style.display = 'none';
          }
        });
      });

      document.getElementById('configForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const submitBtn = this.querySelector('input[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.value = "Guardando...";
        
        const config = {
          keywords: document.getElementById('keywords').value,
          model: document.getElementById('aiModel').value,
          prompt: document.getElementById('prompt').value
        };

        if (!config.model) {
            showStatus('statusFase1', 'Error: Debes seleccionar un modelo de IA.', true);
            submitBtn.disabled = false;
            submitBtn.value = "Guardar Configuración y Activar Proceso Semanal";
            return;
        }
        
        google.script.run
          .withSuccessHandler(function(response) {
            showStatus('statusFase1', response.successMessage, false);
            showStatus('instructionsFase1', response.instructions, false); 
            cargarTriggers();
            cargarConfiguracionActual();
            submitBtn.disabled = false;
            submitBtn.value = "Guardar Configuración y Activar Proceso Semanal";
          })
          .withFailureHandler(function(error) {
            showStatus('statusFase1', 'Error: ' + error.message, true);
            submitBtn.disabled = false;
            submitBtn.value = "Guardar Configuración y Activar Proceso Semanal";
          })
          .guardarConfiguracion(config);
      });
      
      document.getElementById('keywordList').addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('delete-btn')) {
            const keyword = e.target.dataset.keyword;
            if (confirm(`¿Estás seguro de que quieres eliminar la palabra clave "${keyword}"?`)) {
                e.target.disabled = true;
                e.target.innerText = 'Eliminando...';
                google.script.run
                    .withSuccessHandler(function(response) {
                        showStatus('statusKeywords', response, false);
                        cargarConfiguracionActual();
                        cargarTriggers();
                    })
                    .withFailureHandler(function(error) {
                        showStatus('statusKeywords', 'Error: ' + error.message, true);
                        e.target.disabled = false;
                        e.target.innerText = 'Eliminar';
                    })
                    .eliminarKeyword(keyword);
            }
        }
      });

      function addLog(message, isError = false, isSuccess = false) {
        const logContainer = document.getElementById('statusManual');
        logContainer.style.display = 'block';
        const logEntry = document.createElement('p');
        logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        if (isError) logEntry.className = 'log-error';
        if (isSuccess) logEntry.className = 'log-success';
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      document.getElementById('manualProcesoBtn').addEventListener('click', function() {
        const btn = this;
        btn.disabled = true;
        btn.innerText = 'Ejecutando...';
        const logContainer = document.getElementById('statusManual');
        logContainer.innerHTML = '';
        addLog('Iniciando proceso manual...');
        new Promise((resolve, reject) => {
          addLog('Paso 1/4: Obteniendo configuración guardada...');
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .iniciarProcesoManual_Paso1_GetConfig();
        })
        .then(config => {
          addLog(`  > Éxito. Usando modelo: ${config.model}`);
          addLog('Paso 2/4: Buscando noticias recientes...');
          return new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .iniciarProcesoManual_Paso2_SearchNews(config);
          });
        })
        .then(dataForStep3 => {
          addLog(`  > Éxito. Se encontraron ${dataForStep3.noticias.length} noticias.`);
          addLog('Paso 3/4: Generando contenido con IA...');
          return new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .iniciarProcesoManual_Paso3_GenerateContent(dataForStep3);
          });
        })
        .then(dataForStep4 => {
          addLog('  > Éxito. Contenido de la newsletter generado.');
          addLog('Paso 4/4: Enviando newsletter por correo...');
          return new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .iniciarProcesoManual_Paso4_SendEmails(dataForStep4);
          });
        })
        .then(finalMessage => {
          addLog(finalMessage, false, true);
        })
        .catch(error => {
          addLog(`ERROR: ${error.message}`, true);
        })
        .finally(() => {
          btn.disabled = false;
          btn.innerText = 'Buscar Noticias y Enviar Newsletter';
        });
      });

      document.getElementById('emailForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const emailInput = document.getElementById('email');
        const email = emailInput.value.trim();
        if (!email) return;
        
        const submitBtn = this.querySelector('input[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.value = "Agregando...";

        google.script.run
          .withSuccessHandler(function(response) {
            showStatus('statusEmail', response, false);
            emailInput.value = '';
            cargarCorreos();
            submitBtn.disabled = false;
            submitBtn.value = "Agregar Correo";
          })
          .withFailureHandler(function(error) {
            showStatus('statusEmail', 'Error: ' + error.message, true);
            submitBtn.disabled = false;
            submitBtn.value = "Agregar Correo";
          })
          .agregarCorreo(email);
      });
      
      document.getElementById('emailList').addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('delete-btn')) {
          e.target.disabled = true; 
          const email = e.target.dataset.email;
          if (confirm(`¿Estás seguro de que quieres eliminar el correo "${email}"?`)) {
            google.script.run
              .withSuccessHandler(function(response) {
                showStatus('statusEmail', response, false);
                cargarCorreos();
              })
              .withFailureHandler(function(error) {
                showStatus('statusEmail', 'Error: ' + error.message, true);
                e.target.disabled = false; 
              })
              .eliminarCorreo(email);
          } else {
            e.target.disabled = false;
          }
        }
      });
    </script>
  </body>
</html>
