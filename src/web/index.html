<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <!-- La etiqueta viewport ya no está aquí, la añade Code.gs -->
  <?!= include('src/web/stylesheet.html'); ?>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Dashboard de Newsletters</h1>
      <div class="header-actions">
        <a id="spreadsheetLink" href="#" target="_blank" class="btn btn-outline-secondary" style="visibility: hidden;">Abrir Google Sheet</a>
        <button id="createNewBtn" class="btn btn-primary">Crear Nueva Newsletter</button>
      </div>
    </div>

    <div id="newslettersDashboard">
      <p>Cargando newsletters...</p>
    </div>
  </div>

  <!-- Modal para Crear/Editar Newsletter -->
  <div id="newsletterModal" class="modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="newsletterForm">
          <div class="modal-header">
            <h5 id="modalTitle" class="modal-title">Configurar Newsletter</h5>
            <button type="button" class="close" data-dismiss="modal">&times;</button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="id" name="id">
            <div class="form-group">
              <label for="name">Nombre de la Newsletter</label>
              <input type="text" id="name" name="name" class="form-control" required>
            </div>
            <div class="form-group">
              <div class="form-check">
                <input type="checkbox" id="isEnabled" name="isEnabled" class="form-check-input">
                <label for="isEnabled">Activada (el proceso automático se ejecutará)</label>
              </div>
            </div>
            <div class="form-group">
              <label for="keywords">Palabras Clave (separadas por comas)</label>
              <input type="text" id="keywords" name="keywords" class="form-control">
            </div>
            <div class="form-group">
              <label for="aiModel">Modelo de IA</label>
              <select id="aiModel" name="model" class="form-control" disabled><option>Cargando...</option></select>
            </div>
            <div class="form-group">
              <label for="prompt">Prompt para la IA</label>
              <textarea id="prompt" name="prompt" rows="10" class="form-control"></textarea>
            </div>
            <div class="form-grid-columns">
              <div class="form-group">
                <label for="dayOfWeek">Día de envío</label>
                <select id="dayOfWeek" name="dayOfWeek" class="form-control">
                  <option value="MONDAY">Lunes</option> <option value="TUESDAY">Martes</option> <option value="WEDNESDAY">Miércoles</option>
                  <option value="THURSDAY">Jueves</option> <option value="FRIDAY">Viernes</option> <option value="SATURDAY">Sábado</option> <option value="SUNDAY">Domingo</option>
                </select>
              </div>
              <div class="form-group">
                <label for="hour">Hora de envío</label>
                <select id="hour" name="hour" class="form-control"></select>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal para Gestionar Destinatarios -->
  <div id="recipientsModal" class="modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="recipientsModalTitle" class="modal-title">Gestionar Destinatarios</h5>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <form id="recipientForm">
            <input type="hidden" id="recipientNewsletterId">
            <div style="display: flex; gap: 0.5rem;">
              <input type="email" id="recipientEmail" class="form-control" placeholder="nuevo@correo.com" required style="flex-grow: 1;">
              <button type="submit" class="btn btn-primary">Agregar</button>
            </div>
          </form>
          <ul id="recipientList"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Elemento HTML para el Reloj de Carga -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <script>
    const AppState = { newsletters: [], models: [] };
    
    // --- FUNCIONES PARA CONTROLAR EL RELOJ ---
    function showLoader() { document.getElementById('loadingOverlay').style.display = 'flex'; }
    function hideLoader() { document.getElementById('loadingOverlay').style.display = 'none'; }

    // --- RENDER FUNCTIONS ---
    function renderDashboard() {
      const container = document.getElementById('newslettersDashboard');
      if (AppState.newsletters.length === 0) {
        container.innerHTML = '<p>No has creado ninguna newsletter todavía. ¡Haz clic en "Crear Nueva Newsletter" para empezar!</p>';
        return;
      }
      container.innerHTML = AppState.newsletters.map(n => `
        <div class="newsletter-card" data-id="${n.id}">
          <div class="card-header">
            <h3>${n.name}</h3>
            <label class="switch" title="${n.isEnabled ? 'Activada' : 'Desactivada'}">
              <input type="checkbox" data-action="toggle-status" ${n.isEnabled ? 'checked' : ''}>
              <span class="slider round"></span>
            </label>
          </div>
          <div class="card-body">
            <p><strong>Keywords:</strong> <span class="keywords">${n.keywords || 'Ninguna'}</span></p>
            <p><strong>Programación:</strong> ${n.dayOfWeek} a las ${String(n.hour).padStart(2, '0')}:00</p>
            <p><strong>Destinatarios:</strong> ${n.recipients.length}</p>
            <div id="log-${n.id}" class="log-container"></div>
          </div>
          <div class="card-footer">
            <button class="btn btn-secondary btn-sm" data-action="edit">Editar</button>
            <button class="btn btn-secondary btn-sm" data-action="recipients">Destinatarios</button>
            <button class="btn btn-warning btn-sm" data-action="run">Ejecutar Ahora</button>
            <button class="btn btn-danger btn-sm" data-action="delete">Eliminar</button>
          </div>
        </div>
      `).join('');
    }

    // --- MODAL HANDLING ---
    const newsletterModal = document.getElementById('newsletterModal');
    const recipientsModal = document.getElementById('recipientsModal');
    
    function showModal(modal) { modal.style.display = 'block'; }
    function hideModal(modal) { modal.style.display = 'none'; }
    
    document.querySelectorAll('[data-dismiss="modal"]').forEach(el => {
      el.addEventListener('click', () => {
        hideModal(newsletterModal);
        hideModal(recipientsModal);
      });
    });

    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', initialize);

    document.getElementById('createNewBtn').addEventListener('click', handleCreateNew);
    document.getElementById('newslettersDashboard').addEventListener('click', handleCardAction);
    document.getElementById('newsletterForm').addEventListener('submit', handleSaveNewsletter);
    document.getElementById('recipientForm').addEventListener('submit', handleAddRecipient);
    document.getElementById('recipientsModal').addEventListener('click', handleDeleteRecipient);

    // --- INITIALIZATION ---
    function initialize() {
      populateHourSelect();
      loadModels();
      loadNewsletters(); // Carga inicial de newsletters
      loadSpreadsheetUrl();
    }
    
    function loadSpreadsheetUrl() {
      google.script.run.withSuccessHandler(url => {
        const link = document.getElementById('spreadsheetLink');
        if (link && url) {
          link.href = url;
          link.style.visibility = 'visible';
        }
      }).getSpreadsheetUrl();
    }

    /**
     * FIX: Modificada para aceptar un callback que se ejecuta al finalizar.
     * Esto asegura que el loader se oculte solo después de que todo haya terminado.
     * @param {Function} [callback] - Función opcional a ejecutar al completarse.
     */
    function loadNewsletters(callback) {
      showLoader();
      google.script.run
        .withSuccessHandler(newsletters => {
          AppState.newsletters = newsletters;
          renderDashboard();
          hideLoader();
          if (typeof callback === 'function') {
            callback();
          }
        })
        .withFailureHandler(err => {
          alert('Error al cargar newsletters: ' + err.message);
          hideLoader();
           if (typeof callback === 'function') {
            callback();
          }
        })
        .getNewslettersWithData();
    }
    
    function loadModels() {
        google.script.run
            .withSuccessHandler(models => {
                AppState.models = models.filter(m => m.supportedMethods.includes('generateContent'));
                const select = document.getElementById('aiModel');
                select.innerHTML = AppState.models.map(m => `<option value="${m.name}">${m.displayName}</option>`).join('');
                select.disabled = false;
            })
            .withFailureHandler(err => alert('Error al cargar modelos de IA: ' + err.message))
            .listarModelosGemini();
    }

    function populateHourSelect() {
      const select = document.getElementById('hour');
      select.innerHTML = Array.from({length: 24}, (_, i) => `<option value="${i}">${String(i).padStart(2,'0')}:00</option>`).join('');
    }

    // --- ACTION HANDLERS ---
    function handleCreateNew() {
      const form = document.getElementById('newsletterForm');
      form.reset();
      document.getElementById('modalTitle').textContent = 'Crear Nueva Newsletter';
      document.getElementById('id').value = '';
      document.getElementById('aiModel').value = AppState.models[0]?.name || '';
      google.script.run.withSuccessHandler(prompt => document.getElementById('prompt').value = prompt).getDefaultPrompt();
      showModal(newsletterModal);
    }
    
    function handleCardAction(e) {
      if (!e.target.dataset.action) return;
      const action = e.target.dataset.action;
      const card = e.target.closest('.newsletter-card');
      const id = card.dataset.id;
      const newsletter = AppState.newsletters.find(n => n.id === id);

      if (action === 'edit') handleEdit(newsletter);
      if (action === 'delete') handleDelete(id, newsletter.name);
      if (action === 'recipients') handleRecipients(newsletter);
      if (action === 'run') handleRunManual(id, e.target);
      if (action === 'toggle-status') handleToggleStatus(id, e.target);
    }
    
    function handleEdit(newsletter) {
      document.getElementById('modalTitle').textContent = `Editando: ${newsletter.name}`;
      Object.keys(newsletter).forEach(key => {
        const input = document.getElementById(key);
        if (input) {
          if (input.type === 'checkbox') input.checked = newsletter[key];
          else input.value = newsletter[key];
        }
      });
      document.getElementById('aiModel').value = newsletter.model;
      showModal(newsletterModal);
    }

    /**
     * FIX: Lógica mejorada para que el loader se mantenga visible
     * hasta que la lista de newsletters se haya recargado.
     */
    function handleDelete(id, name) {
      if (!confirm(`¿Estás seguro de que quieres eliminar la newsletter "${name}"? Esta acción no se puede deshacer.`)) return;
      showLoader(); // Muestra el loader
      google.script.run
        .withSuccessHandler(() => {
          // No oculta el loader. Llama a loadNewsletters que lo hará al terminar.
          loadNewsletters();
        })
        .withFailureHandler(err => {
          hideLoader(); // Oculta el loader solo si hay un error
          alert('Error al eliminar: ' + err.message);
        })
        .deleteNewsletter(id);
    }
    
    /**
     * FIX: Lógica mejorada para mantener el loader visible durante todo el proceso
     * de guardado y recarga de la lista.
     */
    function handleSaveNewsletter(e) {
      e.preventDefault();
      const form = e.target;
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Guardando...';
      showLoader(); // Muestra el loader al inicio del todo.

      const config = Object.fromEntries(new FormData(form));
      config.isEnabled = document.getElementById('isEnabled').checked;

      // Esta función se ejecutará al final de todo para reactivar el botón.
      const onComplete = () => {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Guardar Cambios';
      };

      google.script.run
        .withSuccessHandler(() => {
          hideModal(newsletterModal);
          // Llama a recargar la lista y le pasa 'onComplete' para que se ejecute al final.
          // loadNewsletters se encargará de ocultar el loader por sí mismo.
          loadNewsletters(onComplete);
        })
        .withFailureHandler(err => {
          alert('Error al guardar: ' + err.message);
          hideLoader(); // Oculta el loader si falla el guardado.
          onComplete(); // Y reactiva el botón.
        })
        .saveNewsletter(config);
    }

    function handleToggleStatus(id, checkbox) {
      checkbox.disabled = true; // Desactivar mientras se procesa
      const label = checkbox.closest('.switch');

      google.script.run
        .withSuccessHandler(newStatus => {
          // Actualizar el estado en el objeto global AppState
          const newsletter = AppState.newsletters.find(n => n.id === id);
          if (newsletter) {
            newsletter.isEnabled = newStatus;
          }
          // Actualizar visualmente el interruptor
          checkbox.checked = newStatus; 
          if(label) label.title = newStatus ? 'Activada' : 'Desactivada';
          checkbox.disabled = false;
        })
        .withFailureHandler(err => {
          alert('Error al cambiar el estado: ' + err.message);
          // Revertir el estado del checkbox en caso de error
          checkbox.checked = !checkbox.checked; 
          if(label) label.title = checkbox.checked ? 'Activada' : 'Desactivada';
          checkbox.disabled = false;
        })
        .toggleNewsletterStatus(id);
    }
    
    // --- RECIPIENTS LOGIC ---
    function handleRecipients(newsletter) {
      document.getElementById('recipientsModalTitle').textContent = `Destinatarios de: ${newsletter.name}`;
      document.getElementById('recipientNewsletterId').value = newsletter.id;
      renderRecipients(newsletter.id, newsletter.recipients);
      showModal(recipientsModal);
    }

    function renderRecipients(id, recipients) {
      const list = document.getElementById('recipientList');
      if(recipients.length === 0) {
        list.innerHTML = '<p>No hay destinatarios en esta lista.</p>';
        return;
      }
      list.innerHTML = recipients.map(email => `
        <li>
          <span>${email}</span>
          <button class="btn btn-danger btn-sm" data-action="delete-recipient" data-email="${email}">Eliminar</button>
        </li>
      `).join('');
    }

    function handleAddRecipient(e) {
      e.preventDefault();
      const form = e.target;
      const submitBtn = form.querySelector('button[type="submit"]');
      const newsletterId = document.getElementById('recipientNewsletterId').value;
      const emailInput = document.getElementById('recipientEmail');
      const email = emailInput.value.trim();
      if (!email) return;

      submitBtn.disabled = true;

      const onComplete = () => {
        submitBtn.disabled = false;
      };

      google.script.run
        .withSuccessHandler(() => {
          emailInput.value = '';
          const nl = AppState.newsletters.find(n => n.id === newsletterId);
          nl.recipients.push(email);
          renderRecipients(newsletterId, nl.recipients);
          renderDashboard(); // To update recipient count
          onComplete();
        })
        .withFailureHandler(err => {
          alert(err.message);
          onComplete();
        })
        .addRecipient(newsletterId, email);
    }

    function handleDeleteRecipient(e) {
      if (e.target.dataset.action !== 'delete-recipient') return;
      const deleteBtn = e.target;
      const newsletterId = document.getElementById('recipientNewsletterId').value;
      const email = e.target.dataset.email;
      
      deleteBtn.disabled = true;
      deleteBtn.textContent = '...';
      
      const onComplete = () => {
          deleteBtn.disabled = false;
          deleteBtn.textContent = 'Eliminar';
      };

      google.script.run
        .withSuccessHandler(() => {
          const nl = AppState.newsletters.find(n => n.id === newsletterId);
          nl.recipients = nl.recipients.filter(r => r !== email);
          renderRecipients(newsletterId, nl.recipients);
          renderDashboard(); // To update recipient count
          onComplete();
        })
        .withFailureHandler(err => {
            alert(err.message);
            onComplete();
        })
        .deleteRecipient(newsletterId, email);
    }

    // --- MANUAL RUN LOGIC ---
    function handleRunManual(id, btn) {
      btn.disabled = true;
      btn.textContent = 'Ejecutando...';
      const logContainer = document.getElementById(`log-${id}`);
      logContainer.innerHTML = '';
      logContainer.style.display = 'block';
      const addLog = (msg, isError=false, isSuccess=false) => {
        const p = document.createElement('p');
        p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        if(isError) p.className = 'log-error';
        if(isSuccess) p.className = 'log-success';
        logContainer.appendChild(p);
        logContainer.scrollTop = logContainer.scrollHeight;
      };

      addLog('Iniciando proceso manual...');
      
      new Promise((resolve, reject) => {
          addLog('Paso 1/4: Obteniendo configuración...');
          google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).iniciarProcesoManual_Paso1_GetConfig(id);
        })
        .then(config => {
          addLog(`  > Éxito. Usando modelo: ${config.model}`);
          addLog('Paso 2/4: Buscando noticias...');
          return new Promise((resolve, reject) => {
            google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).iniciarProcesoManual_Paso2_SearchNews(config);
          });
        })
        .then(dataForStep3 => {
          addLog(`  > Éxito. Se encontraron ${dataForStep3.noticias.length} noticias.`);
          addLog('Paso 3/4: Generando contenido con IA...');
          return new Promise((resolve, reject) => {
            google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).iniciarProcesoManual_Paso3_GenerateContent(dataForStep3);
          });
        })
        .then(dataForStep4 => {
          addLog('  > Éxito. Contenido de la newsletter generado.');
          addLog('Paso 4/4: Enviando newsletter por correo...');
          return new Promise((resolve, reject) => {
            google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).iniciarProcesoManual_Paso4_SendEmails(dataForStep4);
          });
        })
        .then(finalMessage => {
          addLog(finalMessage, false, true);
        })
        .catch(error => {
          addLog(`ERROR: ${error.message}`, true);
        })
        .finally(() => {
          btn.disabled = false;
          btn.textContent = 'Ejecutar Ahora';
        });
    }
  </script>
</body>
</html>